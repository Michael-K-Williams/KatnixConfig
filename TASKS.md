I want to create a new subdirectory in this directory, and create a new version of my configuration. In this configuration I would like the following.


flake.nix
```nix
{
    description = "Katnix Containerised Configuration";
    inputs = {
        home-manager = {
            url = "github:nix-community/home-manager/release-25.05";
            inputs.nixpkgs.follows = "nixpkgs";
        };
        plasma-manager = {
            url = "github:nix-community/plasma-manager";
            inputs.nixpkgs.follows = "nixpkgs";
            inputs.home-manager.follows = "home-manager";
        };
        gx52 = {
            url = "github:Michael-K-Williams/gx52Nix";
            inputs.nixpkgs.follows = "nixpkgs";
        };
    }
    
    outputs = { self, nixpkgs, home-manager, plasma-manager, nix-flatpak, edhm, edmc, vscode-mutable, zsh-p10k-config, claude-code, katnix-commands, gx52, ... }@inputs: 
    let
        machineConfig = import ./machines/machine.nix

}
```

installer.sh
```bash
#!/usr/bin/env bash

# Katnix Installer - Simple NixOS Configuration Installer
set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Configuration
KATNIX_CONFIG_REPO="https://github.com/Michael-K-Williams/KatnixConfig.git"
CONFIG_DIR="$HOME/nixos"
HOSTNAME=""
MACHINE_TYPE=""
USERNAME=$(whoami)

print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE}    Katnix NixOS Installer      ${NC}"
    echo -e "${BLUE}================================${NC}"
    echo ""
}

print_success() { echo -e "${GREEN}✅ $1${NC}"; }
print_error() { echo -e "${RED}❌ $1${NC}"; }
print_warning() { echo -e "${YELLOW}⚠️  $1${NC}"; }
print_info() { echo -e "${BLUE}ℹ️  $1${NC}"; }

# Check prerequisites
check_prerequisites() {
    print_info "Checking prerequisites..."
    
    if [[ $EUID -eq 0 ]]; then
        print_error "Don't run as root! Run as regular user."
        exit 1
    fi
    
    if [[ ! -f /etc/nixos ]] || [[ ! -f /etc/nixos/hardware-configuration.nix ]]; then
        print_error "This doesn't appear to be a NixOS system or hardware-configuration.nix is missing!"
        exit 1
    fi
    
    print_success "Prerequisites check passed"
}

# Get configuration from user
get_user_config() {
    while true; do
        echo "Hostname Configuration"
        while true; do
            echo "Enter the hostname for this machine:"
            read -p "Hostname: " HOSTNAME

            if [[ -z "$HOSTNAME" ]]; then
                print_error "Hostname cannot be empty"
                continue
            fi

            if [[ "$HOSTNAME" =~ [[:space:]] ]]; then
                print_error "Hostname cannot contain spaces"
                continue
            fi

            break
        done

        echo ""
        echo "ℹ️  Hostname will be: $HOSTNAME"
        read -p "Is this correct? (y/n/x): " confirm

        case "$confirm" in
            [Yy])
                print_success "Hostname configured: $HOSTNAME"
                break
                ;;
            [Nn])
                continue
                ;;
            [Xx])
                print_error "Installation cancelled"
                exit 1
                ;;
            *)
                print_error "Please enter y, n, or x"
                ;;
        esac
    done
    
    echo ""
    echo "Machine Type Configuration"
    echo "Select your machine type:"
    echo "1) Desktop - Contains Virtualbox configured within a container, & Two steam accounts configured within two containers with attached tools for Elite Dangerous."
    echo "2) Laptop  - Power-efficient setup,with only a small container containing a steam install."
    echo ""
    echo "   Both of these, come with preinstalled PROTON GE 10-12 for maximum compatibility with steam applications within the steam containers."
    echo ""
    read -p "Enter choice (1 or 2): " choice
    
    case $choice in
        1) MACHINE_TYPE="desktop" ;;
        2) MACHINE_TYPE="laptop" ;;
        *) print_error "Invalid choice"; exit 1 ;;
    esac
    print_success "Machine type: $MACHINE_TYPE"
    
    print_success "Graphics will be auto-detected"
}

# Clone and setup configuration
setup_configuration() {
    print_info "Setting up configuration in $CONFIG_DIR..."
    
    if [[ -d "$CONFIG_DIR" ]]; then
        print_warning "Configuration directory exists. Backing up..."
        mv "$CONFIG_DIR" "${CONFIG_DIR}.backup.$(date +%s)"
    fi
    
    print_info "Cloning Katnix configuration..."
    git clone "$KATNIX_CONFIG_REPO" "$CONFIG_DIR"
    
    cd "$CONFIG_DIR"
    
    print_success "Configuration cloned successfully"
}

# Create machine-specific configuration
create_machine_config() {
    print_info "Creating machine-specific configuration..."
    
    # Create the machine config with universal graphics
    cat > "$CONFIG_DIR/machines/machine.nix" << EOF
{
  # This file is auto-generated by the Katnix installer
  # Machine: $HOSTNAME
  # Type: $MACHINE_TYPE
  # Graphics: Auto-detected
  # Generated: $(date)
  
  hostName = "$HOSTNAME";
  userName = "$USERNAME";
  userDescription = "Katnix User";
  backgroundImagePath = ../kat.png;
  
  # Hardware imports with universal graphics detection
  hardwareImports = [
    ../universal-graphics.nix
  ];
  
  # Machine type configuration (read from persistent config)
  machineType = "$MACHINE_TYPE";
  includeEliteDangerous = $(if [[ "$MACHINE_TYPE" == "desktop" ]]; then echo "true"; else echo "false"; fi);
}
EOF

    print_success "Created machine configuration"
}

# Update flake.nix to use the single machine config
update_flake() {
    print_info "Updating flake configuration..."
    
    # Replace the nixosConfigurations section to use our single machine config
    cat > temp_flake.nix << 'EOF'
{
  description = "NixOS configuration with home-manager";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.05";
    home-manager = {
      url = "github:nix-community/home-manager/release-25.05";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    plasma-manager = {
      url = "github:nix-community/plasma-manager";
      inputs.nixpkgs.follows = "nixpkgs";
      inputs.home-manager.follows = "home-manager";
    };
    nix-flatpak = {
      url = "github:gmodena/nix-flatpak";
    };
    edhm = {
      url = "github:Brighter-Applications/EDHM-Nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    edmc = {
      url = "github:Brighter-Applications/EDMC-Nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    vscode-mutable = {
      url = "github:Michael-K-Williams/VSCode-mutable/main";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    zsh-p10k-config = {
      url = "github:Michael-K-Williams/My-ZshP10k-Nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    claude-code = {
      url = "github:Michael-K-Williams/Claude-Code-Nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    katnix-commands = {
      url = "github:Michael-K-Williams/Katnix-Commands";
      inputs.nixpkgs.follows = "nixpkgs";
    };
  };

  outputs = { self, nixpkgs, home-manager, plasma-manager, nix-flatpak, edhm, edmc, vscode-mutable, zsh-p10k-config, claude-code, katnix-commands, ... }@inputs: 
  let
    machineConfig = import ./machines/machine.nix;
    mkSystem = nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      specialArgs = { inherit inputs machineConfig; };
      modules = [
        ./configuration.nix
        home-manager.nixosModules.home-manager
        edhm.nixosModules.default
        edmc.nixosModules.default
        vscode-mutable.nixosModules.default
        {
          home-manager.useGlobalPkgs = true;
          home-manager.useUserPackages = true;
          home-manager.backupFileExtension = "backup";
          home-manager.extraSpecialArgs = { inherit inputs machineConfig; };
          home-manager.users.${machineConfig.userName} = import ./home.nix;
        }
      ];
    };
  in {
    nixosConfigurations = {
      default = mkSystem;
    };
  };
}
EOF
    
    mv temp_flake.nix flake.nix
    print_success "Updated flake configuration"
}

# Install the system
install_system() {
    print_info "Installing system configuration..."
    print_warning "This will require sudo access"
    
    print_info "Updating flake lock..."
    nix flake update
    
    print_info "Building configuration..."
    nix build ".#nixosConfigurations.default.config.system.build.toplevel" --impure
    
    print_info "Switching to new configuration..."
    sudo nixos-rebuild switch --flake ".#default" --impure
    
    print_success "System configuration installed successfully!"
}

# Main installation process
main() {
    print_header
    check_prerequisites
    echo ""
    get_user_config
    echo ""
    
    echo "Configuration Summary:"
    echo "  Hostname: $HOSTNAME"
    echo "  Machine Type: $MACHINE_TYPE"
    echo "  Graphics: Auto-detected"
    echo "  Configuration Directory: $CONFIG_DIR"
    echo ""
    read -p "Proceed with installation? (y/n): " confirm
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        print_error "Installation cancelled"
        exit 1
    fi
    
    setup_configuration
    create_machine_config
    update_flake
    install_system
    
    echo ""
    print_success "Katnix installation completed!"
    print_info "Your system hostname is: $HOSTNAME"
    print_info "Machine type: $MACHINE_TYPE with auto-detected graphics"
    print_info "Configuration is available at: $CONFIG_DIR"
    echo ""
    print_info "Future updates can be done with:"
    echo "  katnix update"
    echo "  # or manually: cd ~/nixos && sudo nixos-rebuild switch --flake .#default --impure"
    echo ""
    print_warning "You may need to reboot to ensure all changes take effect."
}

main "$@"
```

configuration.nix
    import all modules from subdirectories (for every nix in every subdirectory, including subdirectories of subdirectories)
    (Modules inherit machineConfig) 
    system version 25.05, using LTS Kernel. 
    nix.settings download-buffer-size 1.5GB, experimental features allowed nix-command, flakes
    allow unfree packages systemwide.
    set networking hostname = machineConfig.hostName. enable networkmanager
    enable security.rtkit
    enable pipewire with alsa, alsa32bit, and pulse, disable pulseaudio.

modules/core/boot.nix
```nix
    { config, pkgs, ... }:
    let
    xenlism-grub-theme = pkgs.stdenv.mkDerivation rec {
        pname = "xenlism-grub-theme";
        version = "1.0";
        
        src = pkgs.fetchzip {
        url = "https://github.com/xenlism/Grub-themes/archive/096b311f88ba10960f89d42dffa5b4229e752ca2.zip";
        sha256 = "sha256-kHDYGNM4z8V/JYtBXgAMuf1l/6JSi6YgguSuiuSp2ZY=";
        };
        
        installPhase = ''
        mkdir -p $out
        cp -r xenlism-grub-1080p-nixos/* $out/
        '';
        
        meta = with pkgs.lib; {
        description = "Xenlism Grub Theme for NixOS (1080p)";
        homepage = "https://github.com/xenlism/Grub-themes";
        license = licenses.gpl3;
        platforms = platforms.linux;
        };
    };
    in
    {
    # Bootloader configuration
    boot.loader = {
        grub = {
        enable = true;
        efiSupport = true;
        device = "nodev";
        theme = xenlism-grub-theme;
        };
        efi.canTouchEfiVariables = true;
    };
    }
```

modules/core/desktop.nix
```nix
    { config, pkgs, machineConfig, ... }:
    {
    # Desktop environment configuration
    services = {
        xserver = {
        enable = true; # Required for GDM even with Wayland
        displayManager.gdm.enable = true;
        xkb = {
            layout = "gb";
            variant = "";
        };
        };
        
        displayManager = {
        defaultSession = "plasma";
        sddm = {
            theme = "where_is_my_sddm_theme"; # for lock screen, which always uses sddm
            package = pkgs.kdePackages.sddm-kcm;
        };
        };
        desktopManager.plasma6.enable = true;
        printing.enable = true;
        
        # Bluetooth
        blueman.enable = true;
    };
    
    # Enable Bluetooth hardware
    hardware.bluetooth = {
        enable = true;
        powerOnBoot = true;
    };

    # Exclude unwanted KDE packages
    environment.plasma6.excludePackages = with pkgs.kdePackages; [
        plasma-browser-integration
        konsole
        elisa
        ark
        khelpcenter
        okular
        kscreenlocker
        
    ];
    }
```

modules/core/hostpackages.nix
```nix
{ config, pkgs, inputs, ... }:
{
  # Font configuration
  fonts = { # I like fonts, don't judge me.
    enableDefaultPackages = true;
    packages = with pkgs; [
      nerd-fonts.fira-code
      nerd-fonts.jetbrains-mono
      nerd-fonts.ubuntu-mono
      nerd-fonts.dejavu-sans-mono
      cascadia-code
      nerd-fonts.meslo-lg
      nerd-fonts.droid-sans-mono
      google-fonts
      source-code-pro
      jetbrains-mono
      ubuntu_font_family
      dejavu_fonts
      liberation_ttf
      cascadia-code
      ibm-plex
      font-awesome
      powerline-fonts
      material-design-icons
      noto-fonts
      noto-fonts-cjk-sans
      noto-fonts-emoji
    ];
    fontconfig = {
      defaultFonts = {
        monospace = [ "JetBrains Mono" "Fira Code" "Source Code Pro" "DejaVu Sans Mono" ];
      };
    };
  };

  environment.systemPackages = with pkgs; [
    # Core system tools
    vim 
    wget
    curl
    git
    gh
    unzip
    htop
    alacritty
    zsh
    fastfetch
    bat
    lsd
    tree

    # System utilities
    polkit
    networkmanagerapplet 
    
    # Desktop applications
    firefox
    libreoffice
    vlc
    gimp
    
    # KDE packages
    kdePackages.sddm-kcm # SDDM Management
    kdePackages.kcalc # Calculator - Doesn't come by standard with SDDM for some reason?
    kdePackages.konversation # IRC Client
    kdePackages.ghostwriter # Markdown Editor
    kdePackages.partitionmanager 
    kdePackages.filelight # GUI Storage Manager
    kdePackages.kmail # Email Client
    kdePackages.kdenlive # Video Editor
    kdePackages.kcolorchooser # Colour Chooser
    kdePackages.gwenview # Image Viewer
    
    where-is-my-sddm-theme # SDDM theme
  ];

  programs.direnv = {
    enable = true;
    nix-direnv.enable = true;
  };
}
```

modules/core/users.nix
```nix
{ config, pkgs, machineConfig, ... }:
{
  # User configuration
  users.users.${machineConfig.userName} = {
    isNormalUser = true;
    description = machineConfig.userDescription;
    extraGroups = [ "networkmanager" "wheel" "plugdev" ];
  };

  programs.zsh.enable = true;
  users.defaultUserShell = pkgs.zsh;
}
```

modules/core/locale.nix
```nix
{
    # Time Zone
    time.timeZone = "Europe/London";

    # Keymap
    console.keyMap = "uk";

    # Locale
    i18n = {
        defaultLocale = "en_GB.UTF-8";
        extraLocaleSettings = {
            LC_ADDRESS = "en_GB.UTF-8";
            LC_IDENTIFICATION = "en_GB.UTF-8";
            LC_MEASUREMENT = "en_GB.UTF-8";
            LC_MONETARY = "en_GB.UTF-8";
            LC_NAME = "en_GB.UTF-8";
            LC_NUMERIC = "en_GB.UTF-8";
            LC_PAPER = "en_GB.UTF-8";
            LC_TELEPHONE = "en_GB.UTF-8";
            LC_TIME = "en_GB.UTF-8";
        };
    };
}
```

